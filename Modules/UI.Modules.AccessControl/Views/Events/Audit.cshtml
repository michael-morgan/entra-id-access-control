@model IEnumerable<Api.Modules.AccessControl.Persistence.Entities.Audit.AuditLog>

@{
    ViewData["Title"] = "Technical Audit Logs";
}

<h2>Technical Audit Logs</h2>

<div class="mb-3">
    <form method="get" class="form-inline">
        <div class="form-group mr-2">
            <label for="userId" class="mr-2">User ID:</label>
            <input type="text" name="userId" id="userId" class="form-control" value="@ViewBag.UserId" placeholder="Filter by User ID" />
        </div>
        <div class="form-group mr-2">
            <label for="entityType" class="mr-2">Entity Type:</label>
            <input type="text" name="entityType" id="entityType" class="form-control" value="@ViewBag.EntityType" placeholder="Filter by Entity Type" />
        </div>
        <div class="form-group mr-2">
            <label for="startDate" class="mr-2">From:</label>
            <input type="date" name="startDate" id="startDate" class="form-control" value="@ViewBag.StartDate" />
        </div>
        <div class="form-group mr-2">
            <label for="endDate" class="mr-2">To:</label>
            <input type="date" name="endDate" id="endDate" class="form-control" value="@ViewBag.EndDate" />
        </div>
        <div class="form-group mr-2">
            <label for="pageSize" class="mr-2">Page Size:</label>
            <select name="pageSize" id="pageSize" class="form-control">
                <option value="25" selected="@(ViewBag.PageSize == 25)">25</option>
                <option value="50" selected="@(ViewBag.PageSize == 50)">50</option>
                <option value="100" selected="@(ViewBag.PageSize == 100)">100</option>
            </select>
        </div>
        <button type="submit" class="btn btn-primary">Search</button>
        <a asp-action="Audit" class="btn btn-secondary ml-2">Clear</a>
    </form>
</div>

<div class="alert alert-info">
    <strong>Note:</strong> Technical audit logs capture database changes (INSERT, UPDATE, DELETE). For business-level events, see the <a asp-action="Index">Business Events</a> page.
</div>

<table class="table table-hover table-sm">
    <thead>
        <tr>
            <th>Audit ID</th>
            <th>Timestamp</th>
            <th>User</th>
            <th>Workstream</th>
            <th>Business Process</th>
            <th>Entity Type</th>
            <th>Entity ID</th>
            <th>Action</th>
            <th>IP Address</th>
            <th></th>
        </tr>
    </thead>
    <tbody>
@if (Model.Any())
{
    var userDisplayNames = ViewBag.UserDisplayNames as Dictionary<string, string> ?? new Dictionary<string, string>();
    foreach (var item in Model)
    {
        var userName = (!string.IsNullOrEmpty(item.UserId) && userDisplayNames.TryGetValue(item.UserId, out var displayName)) ? displayName : item.UserId;
        <tr>
            <td><code>@item.AuditId</code></td>
            <td>@item.UpdatedAt.ToString("yyyy-MM-dd HH:mm:ss")</td>
            <td title="@item.UserId">@userName</td>
            <td>@item.WorkstreamId</td>
            <td>
                @if (!string.IsNullOrWhiteSpace(item.BusinessProcessId))
                {
                    <code>@item.BusinessProcessId</code>
                }
            </td>
            <td>@item.EntityType</td>
            <td>@item.EntityId</td>
            <td>@item.Action</td>
            <td>@item.IpAddress</td>
            <td>
                <a href="#" class="btn btn-sm btn-info" data-toggle="modal" data-target="#auditModal-@item.AuditId">View Data</a>
            </td>
        </tr>

        <!-- Modal for audit data -->
        <div class="modal fade" id="auditModal-@item.AuditId" tabindex="-1" role="dialog">
            <div class="modal-dialog modal-lg" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title">Audit Log Data - @item.AuditId</h5>
                        <button type="button" class="close" data-dismiss="modal">
                            <span>&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <dl class="row">
                            <dt class="col-sm-3">Entity Type:</dt>
                            <dd class="col-sm-9">@item.EntityType</dd>

                            <dt class="col-sm-3">Entity ID:</dt>
                            <dd class="col-sm-9">@item.EntityId</dd>

                            <dt class="col-sm-3">Action:</dt>
                            <dd class="col-sm-9">@item.Action</dd>

                            <dt class="col-sm-3">User:</dt>
                            <dd class="col-sm-9">
                                @userName
                                @if (userName != item.UserId)
                                {
                                    <br /><small class="text-muted">User ID: <code>@item.UserId</code></small>
                                }
                            </dd>

                            <dt class="col-sm-3">Request Correlation:</dt>
                            <dd class="col-sm-9"><code>@item.RequestCorrelationId</code></dd>
                        </dl>

                        <h6>Audit Data (JSON)</h6>
                        <pre class="bg-light p-3" style="max-height: 400px; overflow-y: auto;"><code>@item.AuditData</code></pre>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    </div>
                </div>
            </div>
        </div>
    }
}
else
{
    <tr>
        <td colspan="10" class="text-center">No audit logs found for the selected criteria.</td>
    </tr>
}
    </tbody>
</table>

<div class="mt-3">
    <p>Showing @Model.Count() records</p>
</div>
