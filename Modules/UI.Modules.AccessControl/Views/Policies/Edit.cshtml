@model UI.Modules.AccessControl.Models.PolicyViewModel

@{
    ViewData["Title"] = "Edit Policy";
}

<h2>Edit Policy</h2>

<h4>Casbin Policy</h4>
<hr />
<div class="row">
    <div class="col-md-8">
        <form asp-action="Edit">
            <div asp-validation-summary="ModelOnly" class="text-danger"></div>
            <input type="hidden" asp-for="Id" />

            <div class="form-group">
                <label asp-for="PolicyType" class="control-label"></label>
                <select asp-for="PolicyType" class="form-control">
                    <option value="p">p (Policy)</option>
                    <option value="g">g (Role/Group)</option>
                    <option value="g2">g2 (Domain Role)</option>
                </select>
                <span asp-validation-for="PolicyType" class="text-danger"></span>
            </div>

            <div class="form-group">
                <label asp-for="V0" class="control-label">V0 (Subject)</label>
                <div class="input-group">
                    <input asp-for="V0" class="form-control" id="V0Input" placeholder="Enter subject ID or select from dropdown" />
                    <select class="form-select" id="V0SubjectDropdown" style="max-width: 50%;">
                        <option value="">-- Select Subject --</option>
                        <optgroup label="Groups" id="V0GroupsOptgroup">
                            @if (ViewBag.Groups != null)
                            {
                                foreach (var group in ViewBag.Groups)
                                {
                                    <option value="@group.Id" data-displayname="@group.DisplayName" data-type="Group">@group.DisplayName</option>
                                }
                            }
                        </optgroup>
                        <optgroup label="Users" id="V0UsersOptgroup">
                            @if (ViewBag.Users != null)
                            {
                                foreach (var user in ViewBag.Users)
                                {
                                    <option value="@user.Id" data-displayname="@user.DisplayName" data-type="User">@user.DisplayName</option>
                                }
                            }
                        </optgroup>
                        <optgroup label="Roles" id="V0RolesOptgroup">
                            @if (ViewBag.AvailableRoles != null)
                            {
                                foreach (var role in ViewBag.AvailableRoles)
                                {
                                    <option value="@role" data-displayname="@role" data-type="Role">@role</option>
                                }
                            }
                        </optgroup>
                    </select>
                </div>
                <span asp-validation-for="V0" class="text-danger"></span>
                <div class="form-text" id="V0Help">Subject (role) for 'p' policies, or subject (group OID/user OID/role) for 'g' policies</div>
            </div>

            <div class="form-group">
                <label asp-for="V1" class="control-label">V1 (Workstream/Role)</label>
                <div class="input-group">
                    <input asp-for="V1" class="form-control" id="V1Input" placeholder="For 'p': workstream, for 'g': parent role" />
                    <select class="form-control" id="V1Select" style="max-width: 50%;">
                        <option value="">-- Select --</option>
                    </select>
                </div>
                <span asp-validation-for="V1" class="text-danger"></span>
                <small class="form-text text-muted">For 'p' policies: workstream/domain. For 'g' policies: parent role name.</small>
            </div>

            <div class="form-group">
                <label asp-for="V2" class="control-label">V2 (Resource/Domain)</label>
                <div class="input-group">
                    <input asp-for="V2" class="form-control" id="V2Input" />
                    <select class="form-control" id="V2Select" style="max-width: 50%;">
                        <option value="">-- Select --</option>
                    </select>
                </div>
                <span asp-validation-for="V2" class="text-danger"></span>
                <small class="form-text text-muted" id="V2Help">For 'p' policies: resource pattern (Loan, Loan/*, etc.). For 'g' policies: workstream/domain.</small>
            </div>

            <div class="form-group">
                <label asp-for="V3" class="control-label">V3 (Action)</label>
                <input asp-for="V3" class="form-control" id="V3Input" placeholder="read, write, list, approve, etc." />
                <span asp-validation-for="V3" class="text-danger"></span>
                <small class="form-text text-muted">For 'p' policies: action (read, write, list, etc.). Leave empty for 'g' policies.</small>
            </div>

            <div class="form-group">
                <label asp-for="V4" class="control-label">V4 (Effect)</label>
                <select asp-for="V4" class="form-control">
                    <option value="">-- Select Effect --</option>
                    <option value="allow">allow</option>
                    <option value="deny">deny</option>
                </select>
                <span asp-validation-for="V4" class="text-danger"></span>
                <small class="form-text text-muted">Effect for 'p' policies (allow/deny)</small>
            </div>

            <div class="form-group">
                <label asp-for="V5" class="control-label">V5</label>
                <input asp-for="V5" class="form-control" />
                <span asp-validation-for="V5" class="text-danger"></span>
                <small class="form-text text-muted">Reserved for future use</small>
            </div>

            <div class="form-group">
                <div class="form-check">
                    <input asp-for="IsActive" class="form-check-input" type="checkbox" />
                    <label asp-for="IsActive" class="form-check-label"></label>
                </div>
                <small class="form-text text-muted">Inactive policies will not be evaluated</small>
            </div>

            <div class="form-group">
                <input type="submit" value="Save" class="btn btn-primary" />
                <a asp-action="Index" class="btn btn-secondary">Cancel</a>
            </div>
        </form>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <style>
        /* Force Select2 container to respect the 50% width */
        .select2-container {
            max-width: 50% !important;
        }

        /* Remove border radius from Select2 to match text input in input-group */
        .input-group .select2-container--bootstrap-5 .select2-selection {
            border-radius: 0 !important;
            border-top-right-radius: 0.375rem !important;
            border-bottom-right-radius: 0.375rem !important;
        }

        /* Hide optgroup labels that are marked as hidden */
        .select2-results__option--group.hidden-optgroup {
            display: none !important;
        }
    </style>
    <script>
        const selectedWorkstream = '@ViewBag.SelectedWorkstream';
        const availableWorkstreams = @Html.Raw(Json.Serialize(ViewBag.AvailableWorkstreams ?? new List<string>()));
        const availableRoles = @Html.Raw(Json.Serialize(ViewBag.AvailableRoles ?? new List<string>()));
        const availableResources = @Html.Raw(Json.Serialize(ViewBag.AvailableResources ?? new List<string>()));

        // Function to show/hide Groups and Users based on policy type
        function updateV0DropdownVisibility(policyType) {
            const dropdown = $('#V0SubjectDropdown');
            const helpText = document.getElementById('V0Help');

            // Destroy Select2 first
            if (dropdown.hasClass('select2-hidden-accessible')) {
                dropdown.select2('destroy');
            }

            // Use jQuery to disable/enable optgroups and their options
            const groupsOptgroup = $('#V0GroupsOptgroup');
            const usersOptgroup = $('#V0UsersOptgroup');

            if (policyType === 'p') {
                // For 'p' policies, only show Roles - disable and hide Groups and Users
                groupsOptgroup.find('option').prop('disabled', true);
                usersOptgroup.find('option').prop('disabled', true);
                groupsOptgroup.hide();
                usersOptgroup.hide();
                helpText.textContent = 'Subject (role) for permission policies';
            } else if (policyType === 'g' || policyType === 'g2') {
                // For 'g' policies, show Groups, Users, and Roles - enable all
                groupsOptgroup.find('option').prop('disabled', false);
                usersOptgroup.find('option').prop('disabled', false);
                groupsOptgroup.show();
                usersOptgroup.show();
                helpText.textContent = 'Subject (group OID/user OID/role) for grouping policies';
            }

            // Reinitialize Select2 after changing visibility
            dropdown.select2({
                theme: 'bootstrap-5',
                placeholder: policyType === 'p' ? 'Search for a role...' : 'Search for a subject...',
                allowClear: true,
                templateResult: function(data) {
                    // Don't render disabled options
                    if (data.disabled) {
                        return null;
                    }
                    return data.text;
                }
            });

            // After Select2 renders, hide the optgroup labels for Groups and Users if policy type is 'p'
            if (policyType === 'p') {
                setTimeout(function() {
                    $('.select2-results__option--group[aria-label="Groups"], .select2-results__option--group[aria-label="Users"]').addClass('hidden-optgroup');
                }, 50);
            }
        }

        // Initialize Select2 on V0 subject dropdown
        $(document).ready(function() {
            const initialPolicyType = $('#PolicyType').val();

            // First, hide optgroups based on initial policy type BEFORE Select2 initialization
            const groupsOptgroup = $('#V0GroupsOptgroup');
            const usersOptgroup = $('#V0UsersOptgroup');

            if (initialPolicyType === 'p') {
                groupsOptgroup.find('option').prop('disabled', true);
                usersOptgroup.find('option').prop('disabled', true);
                groupsOptgroup.hide();
                usersOptgroup.hide();
            }

            // Then initialize Select2 with the already-filtered DOM
            $('#V0SubjectDropdown').select2({
                theme: 'bootstrap-5',
                placeholder: initialPolicyType === 'p' ? 'Search for a role...' : 'Search for a subject...',
                allowClear: true,
                templateResult: function(data) {
                    // Don't render disabled options
                    if (data.disabled) {
                        return null;
                    }
                    return data.text;
                }
            });

            // Always attach handler to hide optgroup labels when dropdown opens
            $('#V0SubjectDropdown').on('select2:open', function() {
                setTimeout(function() {
                    const currentPolicyType = $('#PolicyType').val();
                    if (currentPolicyType === 'p') {
                        $('.select2-results__option--group[aria-label="Groups"], .select2-results__option--group[aria-label="Users"]').addClass('hidden-optgroup');
                    } else {
                        $('.select2-results__option--group[aria-label="Groups"], .select2-results__option--group[aria-label="Users"]').removeClass('hidden-optgroup');
                    }
                }, 10);
            });

            // Sync Select2 selection to text input
            $('#V0SubjectDropdown').on('select2:select', function (e) {
                $('#V0Input').val($(this).val());
            });

            // Clear text input when dropdown is cleared
            $('#V0SubjectDropdown').on('select2:clear', function (e) {
                $('#V0Input').val('');
            });
        });

        // Handle V1 selection
        document.getElementById('V1Select').addEventListener('change', function() {
            if (this.value) {
                document.getElementById('V1Input').value = this.value;
            }
        });

        // Handle resource selection for V2
        const v2Select = document.getElementById('V2Select');
        if (v2Select) {
            v2Select.addEventListener('change', function() {
                if (this.value) {
                    document.getElementById('V2Input').value = this.value;
                }
            });
        }

        // Update V1 dropdown based on policy type
        function updateV1Dropdown(policyType) {
            const v1Select = document.getElementById('V1Select');

            // Clear existing options
            v1Select.innerHTML = '<option value="">-- Select --</option>';

            if (policyType === 'p') {
                // For 'p' policies, show workstreams
                availableWorkstreams.forEach(function(workstream) {
                    const option = document.createElement('option');
                    option.value = workstream;
                    option.textContent = workstream;
                    v1Select.appendChild(option);
                });
            } else if (policyType === 'g' || policyType === 'g2') {
                // For 'g' policies, show roles
                availableRoles.forEach(function(role) {
                    const option = document.createElement('option');
                    option.value = role;
                    option.textContent = role;
                    v1Select.appendChild(option);
                });
            }
        }

        // Update V2 dropdown based on policy type
        function updateV2Dropdown(policyType) {
            const v2Select = document.getElementById('V2Select');

            // Clear existing options
            v2Select.innerHTML = '<option value="">-- Select --</option>';

            if (policyType === 'p') {
                // For 'p' policies, show resources
                availableResources.forEach(function(resource) {
                    const option = document.createElement('option');
                    option.value = resource;
                    option.textContent = resource;
                    v2Select.appendChild(option);
                });
            } else if (policyType === 'g' || policyType === 'g2') {
                // For 'g' policies, show workstreams
                availableWorkstreams.forEach(function(workstream) {
                    const option = document.createElement('option');
                    option.value = workstream;
                    option.textContent = workstream;
                    v2Select.appendChild(option);
                });
            }
        }

        // Handle policy type change
        document.getElementById('PolicyType').addEventListener('change', function() {
            updateV0DropdownVisibility(this.value);
            updateV1Dropdown(this.value);
            updateV2Dropdown(this.value);
        });

        // Initialize V1 and V2 dropdowns on page load (V0 is initialized in jQuery ready)
        window.addEventListener('DOMContentLoaded', function() {
            const policyType = document.getElementById('PolicyType').value;
            updateV1Dropdown(policyType);
            updateV2Dropdown(policyType);
        });
    </script>
}
